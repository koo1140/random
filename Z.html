<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Realtime 3D Scanner</title>
<style>
  html, body { margin:0; height:100%; font-family: Arial, sans-serif; background:#121212; color:#eee; }
  #app { display:grid; grid-template-rows:auto 1fr; gap:8px; height:100%; padding:8px; }
  header { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  button { padding:8px 14px; border-radius:10px; border:none; background:#1f1f1f; color:#eee; cursor:pointer; font-weight:500; transition:0.2s; }
  button:hover { background:#333; }
  label { font-size:13px; display:flex; align-items:center; gap:4px; }
  #viewer { width:100%; height:100%; border-radius:10px; background:#111; overflow:hidden; }
  #controls { display:flex; gap:10px; flex-wrap:wrap; }
  #status { margin-left:auto; font-size:13px; text-align:right; line-height:1.3em; }
  #videoWrapper { position:relative; width:100%; max-width:400px; border-radius:10px; overflow:hidden; }
  #video { width:100%; display:block; border-radius:10px; }
  #log { display:block; height:200px; overflow:auto; background:#222; padding:8px; border-radius:6px; font-size:12px; color:#0f0; }
</style>

<!-- Import Map -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.module.js",
    "three/OrbitControls": "https://cdn.jsdelivr.net/npm/three@0.154.0/examples/jsm/controls/OrbitControls.js"
  }
}
</script>
</head>
<body>
<div id="app">
  <header>
    <div id="controls">
      <button id="btnStart">Start Scan</button>
      <button id="btnStop" disabled>Stop Scan</button>
      <button id="btnExport" disabled>Export PLY</button>
      <label><input type="checkbox" id="checkboxDepthNet"> Depth Fill</label>
      <label><input type="checkbox" id="checkboxMerge" checked> Live Merge</label>
    </div>
    <div id="status">
      <div id="gpsStatus">GPS: —</div>
      <div id="poseStatus">Orientation: —</div>
    </div>
  </header>

  <div style="display:flex; gap:8px; height:100%;">
    <div id="videoWrapper">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="captureCanvas" width="640" height="480" style="display:none"></canvas>
    </div>
    <div id="viewer"></div>
  </div>

  <div id="log"></div>
</div>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/OrbitControls";

// --- Logging ---
const logEl = document.getElementById('log');
function log(...args){
  const s = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : a)).join(' ');
  console.log(s);
  logEl.innerText += s + '\n';
  logEl.scrollTop = logEl.scrollHeight;
}

// --- UI Elements ---
const video = document.getElementById('video');
const canvas = document.getElementById('captureCanvas');
const ctx = canvas.getContext('2d');
const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const btnExport = document.getElementById('btnExport');
const gpsStatus = document.getElementById('gpsStatus');
const poseStatus = document.getElementById('poseStatus');
const depthNet = document.getElementById('checkboxDepthNet');
const liveMerge = document.getElementById('checkboxMerge');

let stream=null, capturing=false, captureTimer=null;

// --- Three.js Scene ---
const viewerEl = document.getElementById('viewer');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);
const camera3D = new THREE.PerspectiveCamera(60, viewerEl.clientWidth/viewerEl.clientHeight, 0.01, 1000);
camera3D.position.set(0,0,3);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(viewerEl.clientWidth, viewerEl.clientHeight);
viewerEl.appendChild(renderer.domElement);
const controls = new OrbitControls(camera3D, renderer.domElement);
scene.add(new THREE.AmbientLight(0xffffff, 1.0));

const pointsGlobal = [];
let pointsMesh=null;
function updatePointsVisual(){
  if(pointsMesh) scene.remove(pointsMesh);
  const geo = new THREE.BufferGeometry();
  const pos = new Float32Array(pointsGlobal.length*3);
  const col = new Float32Array(pointsGlobal.length*3);
  for(let i=0;i<pointsGlobal.length;i++){
    pos[3*i]=pointsGlobal[i].x; pos[3*i+1]=pointsGlobal[i].y; pos[3*i+2]=pointsGlobal[i].z;
    col[3*i]=pointsGlobal[i].r/255; col[3*i+1]=pointsGlobal[i].g/255; col[3*i+2]=pointsGlobal[i].b/255;
  }
  geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
  geo.setAttribute('color', new THREE.BufferAttribute(col,3));
  pointsMesh = new THREE.Points(geo,new THREE.PointsMaterial({size:0.02, vertexColors:true}));
  scene.add(pointsMesh);
}

function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera3D); }
animate();

// --- Device Orientation ---
let lastPose={alpha:0,beta:0,gamma:0};
window.addEventListener('deviceorientation', e=>{
  lastPose={alpha:e.alpha||0,beta:e.beta||0,gamma:e.gamma||0};
  poseStatus.innerText = `α:${lastPose.alpha.toFixed(1)} β:${lastPose.beta.toFixed(1)} γ:${lastPose.gamma.toFixed(1)}`;
});

// --- GPS ---
function startGPS(){
  if(!navigator.geolocation){ log('No GPS'); return; }
  navigator.geolocation.watchPosition(p=>{
    gpsStatus.innerText = `GPS: ${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)}`;
  }, e=>log('GPS error', e.message), {enableHighAccuracy:true, maximumAge:1000});
}

// --- Capture Functions ---
btnStart.addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment', width:{ideal:1280}, height:{ideal:720}}, audio:false});
    video.srcObject = stream;
    startGPS();
    capturing=true; btnStart.disabled=true; btnStop.disabled=false; log('Capture started');

    captureTimer = setInterval(()=>{
      try {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Dummy point generation for testing live point cloud
        if(pointsGlobal.length < 200 && liveMerge.checked){
          pointsGlobal.push({
            x: (Math.random()-0.5)*2,
            y: (Math.random()-0.5)*2,
            z: (Math.random()-0.5)*2,
            r: Math.random()*255|0,
            g: Math.random()*255|0,
            b: Math.random()*255|0
          });
          updatePointsVisual();
        }
      } catch(e){
        log("Capture error:", e);
      }
    }, 200);
  }catch(e){ log('Camera error', e); }
});

btnStop.addEventListener('click', ()=>{
  if(!capturing) return;
  clearInterval(captureTimer); captureTimer=null;
  stream.getTracks().forEach(t=>t.stop());
  capturing=false; btnStart.disabled=false; btnStop.disabled=true;
  log('Capture stopped'); updatePointsVisual();
});

btnExport.addEventListener('click', ()=>{
  try {
    if(pointsGlobal.length===0){
      log("No points to export");
      alert('No points captured');
      return;
    }
    let header = 'ply\nformat ascii 1.0\nelement vertex ' + pointsGlobal.length + 
                 '\nproperty float x\nproperty float y\nproperty float z\nproperty uchar red\nproperty uchar green\nproperty uchar blue\nend_header\n';
    const lines = pointsGlobal.map(p=>`${p.x.toFixed(6)} ${p.y.toFixed(6)} ${p.z.toFixed(6)} ${p.r} ${p.g} ${p.b}`);
    const blob = new Blob([header+lines.join('\n')],{type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `scan_${Date.now()}.ply`; a.click(); 
    URL.revokeObjectURL(url);
    log("Exported", pointsGlobal.length, "points");
  } catch(e){
    log("Export error:", e);
  }
});
</script>
</body>
</html>
