<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Live Spectrogram Heatmap 0-8kHz</title>
<style>
body{text-align:center;font-family:sans-serif;}
canvas{border:1px solid #ccc;margin-top:10px;}
#progress{margin-top:10px;font-family:monospace;white-space:pre-wrap;text-align:left;max-height:200px;overflow:auto;border:1px solid #ccc;padding:5px;}
</style>
</head>
<body>
<h2>Live Spectrogram (6s) - Heatmap 0–8kHz</h2>
<button id="startBtn">Start Mic</button>
<div id="progress">Waiting...</div>
<canvas id="specCanvas" width="800" height="400"></canvas>

<script>
const canvas = document.getElementById("specCanvas");
const ctx = canvas.getContext("2d");
const progress = document.getElementById("progress");
const startBtn = document.getElementById("startBtn");

let audioCtx, analyser, dataArray, bufferLength;
const fs = 44100;
const maxFreq = 8000; // limit frequency to 8 kHz

function log(msg){
    progress.textContent += msg + "\n";
    progress.scrollTop = progress.scrollHeight;
}

window.onerror = function(message, source, lineno, colno, error) {
  log(`ERROR: ${message} at ${source}:${lineno}:${colno}`);
};

// Viridis colormap function
function viridis(value){ // value 0..1
    value = Math.max(0, Math.min(1, value));
    const v = Math.floor(value*255);
    // simplified viridis
    const r = [68,71,68,68,69,71,73,76,79,82,85,88,91,95,98,102,106,109,113,117,121,125,129,133,137,141,145,149,153,157,162,166,171,175,180,184,189,194,198,203,208,212,217,221,226,231,236,240,245,250,253,255];
    const g = [1,2,3,4,6,8,11,14,18,22,27,33,40,47,55,63,71,79,87,94,101,107,112,117,121,124,127,130,132,135,137,140,143,145,148,150,153,155,158,161,163,166,169,172,175,177,180,183,186,189,192,195,198,201];
    const b = [84,85,87,89,92,95,99,103,107,112,116,121,126,131,136,141,147,152,158,164,170,177,183,190,197,204,211,218,224,231,238,244,250,254,255];
    const i = Math.min(r.length-1, v);
    return `rgb(${r[i]},${g[i]},${b[i]})`;
}

// ---- Start Mic ----
startBtn.onclick = async ()=>{
    try{
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        const src = audioCtx.createMediaStreamSource(stream);

        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        bufferLength = analyser.frequencyBinCount;
        dataArray = new Float32Array(bufferLength);

        src.connect(analyser);
        log("Mic started!");
        drawSpectrogram();
    }catch(e){
        log("Mic error: "+e);
    }
};

// ---- Draw Spectrogram ----
function drawSpectrogram(){
    try{
        analyser.getFloatFrequencyData(dataArray); // -100..0 dB

        // shift left
        const img = ctx.getImageData(1,0,canvas.width-1,canvas.height);
        ctx.putImageData(img,0,0);
        ctx.fillStyle = "black";
        ctx.fillRect(canvas.width-1,0,1,canvas.height);

        // map frequency 0–8kHz
        const maxIndex = Math.floor(maxFreq/(fs/2)*bufferLength);

        for(let i=0;i<canvas.height;i++){
            const freqFrac = i/canvas.height;
            const idx = maxIndex - 1 - Math.floor(freqFrac*maxIndex); // invert for plotting low freq bottom
            let v = dataArray[idx]; // dB
            v = (v+100)/100; // normalize 0..1
            v = Math.max(0,Math.min(1,v));
            ctx.fillStyle = viridis(v);
            ctx.fillRect(canvas.width-1, i,1,1);
        }

        // axes
        ctx.fillStyle = "white";
        ctx.font = "12px sans-serif";
        ctx.fillText("Time →", canvas.width-50, canvas.height-5);
        ctx.fillText("Freq 0–8kHz", 5,12);
    }catch(e){
        log("Draw error: "+e);
    }
    requestAnimationFrame(drawSpectrogram);
}
</script>
</body>
</html>
