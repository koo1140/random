<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hand Visualization</title>
<style>
  body { margin:0; overflow:hidden; }
</style>
</head>
<body>

<video id="video" autoplay playsinline style="display:none;"></video>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.154.0/build/three.module.js';
import {Hands} from 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js';

// Three.js setup
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 10);
camera.position.z = 0.5;
const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Video feed
const video = document.getElementById('video');
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(stream => { video.srcObject = stream; })
.catch(err => console.error(err));

// Mediapipe hands
const hands = new Hands({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({maxNumHands:2,modelComplexity:1});
hands.onResults(onHands);

// Three.js objects
let jointSpheres = [];
let boneLines = [];
const jointGeom = new THREE.SphereGeometry(0.01,8,8);
const jointMat = new THREE.MeshNormalMaterial();
const boneMat = new THREE.LineBasicMaterial({color:0x00ff00});
const fingers = [
    [0,1,2,3,4],[0,5,6,7,8],[0,9,10,11,12],[0,13,14,15,16],[0,17,18,19,20]
];

// Hand detection loop
async function detectHands(){
    await hands.send({image:video});
    requestAnimationFrame(detectHands);
}
video.onloadeddata = () => detectHands();

// Callback
function onHands(results){
    jointSpheres.forEach(s=>scene.remove(s)); jointSpheres=[];
    boneLines.forEach(l=>scene.remove(l)); boneLines=[];
    if(!results.multiHandLandmarks) return;

    results.multiHandLandmarks.forEach(landmarks=>{
        // joints
        landmarks.forEach(lm=>{
            const sphere = new THREE.Mesh(jointGeom,jointMat);
            sphere.position.set((lm.x-0.5)*0.4, (0.5-lm.y)*0.4, -lm.z*0.4);
            scene.add(sphere); jointSpheres.push(sphere);
        });
        // bones
        fingers.forEach(finger=>{
            for(let i=0;i<finger.length-1;i++){
                const a=landmarks[finger[i]], b=landmarks[finger[i+1]];
                const points=[new THREE.Vector3((a.x-0.5)*0.4,(0.5-a.y)*0.4,-a.z*0.4),
                              new THREE.Vector3((b.x-0.5)*0.4,(0.5-b.y)*0.4,-b.z*0.4)];
                const line = new THREE.Line(new THREE.BufferGeometry().setFromPoints(points), boneMat);
                scene.add(line); boneLines.push(line);
            }
        });
    });
}

// Render loop
renderer.setAnimationLoop(()=>renderer.render(scene,camera));
</script>
</body>
</html>
