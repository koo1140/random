<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hand Tracking ES Module Manual Video</title>
<style>
  body { margin:0; overflow:hidden; background:#111; color:#eee; font-family:sans-serif;}
  #startButton, #copyLogs { position:absolute; top:20px; padding:10px 20px; font-size:16px; cursor:pointer; z-index:10;}
  #startButton { left:20px; }
  #copyLogs { left:150px; }
  #logs { position:absolute; bottom:0; left:0; width:100%; max-height:40%; overflow:auto; background:rgba(0,0,0,0.8); padding:10px; font-size:12px;}
  video { display:none; }
</style>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.154.0/build/three.module.js"
  }
}
</script>
</head>
<body>

<button id="startButton">Start AR</button>
<button id="copyLogs">Copy Logs</button>
<div id="logs"></div>
<video id="video" autoplay playsinline></video>

<!-- Mediapipe Hands -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script type="module">
import * as THREE from "three";

const logContainer = document.getElementById('logs');
function log(msg){ 
  console.log(msg); 
  logContainer.innerHTML += msg + '<br>'; 
  logContainer.scrollTop = logContainer.scrollHeight;
}
document.getElementById('copyLogs').onclick = ()=>{ 
  navigator.clipboard.writeText(logContainer.innerText).then(()=>log('Logs copied')); 
};

const video = document.getElementById('video');
const startButton = document.getElementById('startButton');

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 10);
camera.position.z = 0.5;
const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

let jointSpheres=[], boneLines=[];
const jointGeom = new THREE.SphereGeometry(0.01,8,8);
const jointMat = new THREE.MeshNormalMaterial();
const boneMat = new THREE.LineBasicMaterial({color:0x00ff00});
const fingers=[[0,1,2,3,4],[0,5,6,7,8],[0,9,10,11,12],[0,13,14,15,16],[0,17,18,19,20]];

let hands;

startButton.onclick = async ()=>{
  startButton.style.display='none';
  try{
    log('Requesting camera...');
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = stream;
    await video.play();
    log('Camera started.');

    try{
      log('Initializing Mediapipe Hands...');
      hands = new Hands({locateFile: (file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
      hands.setOptions({maxNumHands:2, modelComplexity:1, minDetectionConfidence:0.5, minTrackingConfidence:0.5});
      hands.onResults(onHands);
      log('Mediapipe Hands ready.');

      try{
        log('Starting manual hand detection loop...');
        requestAnimationFrame(handLoop);
        log('Hand detection loop started.');
      }catch(e){ log('Manual loop error: '+e); }
    }catch(e){ log('Hands init error: '+e); }
  }catch(e){ log('Camera error: '+e); }
};

async function handLoop(){
  try{
    if(hands && video.readyState >= 2){
      await hands.send({image: video});
    }
  }catch(e){ log('Hand send error: '+e); }
  requestAnimationFrame(handLoop);
}

function onHands(results){
  try{
    jointSpheres.forEach(s=>scene.remove(s)); jointSpheres=[];
    boneLines.forEach(l=>scene.remove(l)); boneLines=[];

    if(!results.multiHandLandmarks) return;
    log('Hands detected: '+results.multiHandLandmarks.length);

    results.multiHandLandmarks.forEach(landmarks=>{
      landmarks.forEach(lm=>{
        const sphere = new THREE.Mesh(jointGeom,jointMat);
        sphere.position.set((lm.x-0.5)*0.4,(0.5-lm.y)*0.4,-lm.z*0.4);
        scene.add(sphere); jointSpheres.push(sphere);
      });
      fingers.forEach(finger=>{
        for(let i=0;i<finger.length-1;i++){
          const a=landmarks[finger[i]], b=landmarks[finger[i+1]];
          const points=[new THREE.Vector3((a.x-0.5)*0.4,(0.5-a.y)*0.4,-a.z*0.4),
                        new THREE.Vector3((b.x-0.5)*0.4,(0.5-b.y)*0.4,-b.z*0.4)];
          const line = new THREE.Line(new THREE.BufferGeometry().setFromPoints(points), boneMat);
          scene.add(line); boneLines.push(line);
        }
      });
    });
  }catch(e){ log('onHands error: '+e); }
}

renderer.setAnimationLoop(()=>{
  try{ renderer.render(scene,camera); }
  catch(e){ log('Render error: '+e); }
});
</script>

</body>
</html>
