<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stereo Echolocation Demo</title>
<style>
body{margin:0;background:#000;color:#0f0;font-family:monospace;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;overflow:hidden}
canvas{background:#010;border:1px solid #0f0;margin-top:10px}
button{margin-top:10px;padding:6px 12px;border:none;background:#030;border:1px solid #0f0;color:#0f0;cursor:pointer}
</style>
</head>
<body>
<h3>ðŸ“¡ Stereo Echolocation</h3>
<button id="pingBtn">Send Ping</button>
<canvas id="radar" width="400" height="400"></canvas>
<script>
const canvas=document.getElementById("radar");
const ctx=canvas.getContext("2d");

let audioCtx, micStream, analyser, dataArray, playing=false;

async function initAudio(){
  try{
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    micStream=await navigator.mediaDevices.getUserMedia({audio:{channelCount:2}});
    const source=audioCtx.createMediaStreamSource(micStream);
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=2048;
    dataArray=new Float32Array(analyser.fftSize);
    source.connect(analyser);
    console.log("Mic initialized!");
  } catch(e){
    alert("Microphone access denied or unavailable. Cannot run echolocation.");
    console.error(e);
  }
}

function playPing(){
  if(!audioCtx) return;
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type="sine";
  osc.frequency.value=15000; // high pitch click
  gain.gain.setValueAtTime(0, audioCtx.currentTime);
  gain.gain.linearRampToValueAtTime(1, audioCtx.currentTime+0.001);
  gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+0.02);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+0.03);
}

function detectEcho(){
  if(!analyser) return; // safety check
  analyser.getFloatTimeDomainData(dataArray);
  const threshold=0.05;
  const echoes=[];
  for(let i=100;i<dataArray.length;i++){
    if(Math.abs(dataArray[i])>threshold){
      echoes.push(i);
    }
  }
  drawRadar(echoes);
}

function drawRadar(echos){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const cx=canvas.width/2,cy=canvas.height/2;
  const maxDistance=bufferLength=analyser.fftSize;
  // concentric circles
  ctx.strokeStyle="#0f0";
  for(let r=50;r<cx;r+=50){
    ctx.beginPath();
    ctx.arc(cx,cy,r,0,2*Math.PI);
    ctx.stroke();
  }
  // plot echoes
  ctx.fillStyle="#0f0";
  echos.forEach(idx=>{
    const r=(idx/maxDistance)*cx;
    // approximate angle from stereo: compare left/right channels
    let angle=Math.random()*2*Math.PI; // placeholder for future stereo direction
    const x=cx+r*Math.cos(angle);
    const y=cy+r*Math.sin(angle);
    ctx.beginPath();
    ctx.arc(x,y,4,0,2*Math.PI);
    ctx.fill();
  });
}

document.getElementById("pingBtn").onclick=async()=>{
  if(!audioCtx) await initAudio();
  playPing();
  setTimeout(detectEcho,50); // wait 50ms for echoes
};
</script>
</body>
</html>
